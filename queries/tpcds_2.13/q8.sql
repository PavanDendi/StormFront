-- q8.sql
-- scale 30000, stream 0, seed 100
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '19939','15415','99532','88109','38905','19375',
                          '56530','18362','35416','27628','20661',
                          '58398','88211','57824','75429','16379',
                          '68109','51982','66597','88140','14017',
                          '44159','60809','65904','73149','96224',
                          '92063','12567','78972','63040','68165',
                          '54050','11163','22929','73892','56920',
                          '52933','19156','71726','33409','65018',
                          '44771','36812','73971','61941','61299',
                          '49344','12756','21081','84478','87438',
                          '29983','67772','27451','39916','45766',
                          '35274','30734','54935','33483','53235',
                          '25329','16082','11293','35637','38153',
                          '37539','89687','53387','98013','57817',
                          '26971','18865','17944','52891','52856',
                          '45241','67343','60253','20965','41056',
                          '88979','53759','96810','53439','14575',
                          '70802','61481','19025','72666','40770',
                          '76110','16417','34436','59210','52858',
                          '72918','87387','73453','29496','43314',
                          '39448','19263','13178','34900','39401',
                          '21274','52207','20946','79761','19120',
                          '74955','13144','43265','64156','29767',
                          '84885','38686','68517','10798','45293',
                          '95575','13753','71966','45132','33216',
                          '52462','82154','74882','22943','37620',
                          '82326','10508','29439','19689','57959',
                          '31232','62344','55851','22384','58946',
                          '36144','12988','24773','87033','10175',
                          '64061','96507','30874','48827','72137',
                          '23783','93874','95190','58465','53478',
                          '30252','40177','68295','23826','48490',
                          '52295','18696','54503','47586','65441',
                          '41599','67646','12498','15048','50271',
                          '76221','68359','61907','45680','44941',
                          '46094','49039','11893','28124','34648',
                          '96966','20444','19766','34211','83840',
                          '10321','59206','45418','55810','43185',
                          '40974','40174','90586','58461','32033',
                          '88417','22559','61475','37287','32411',
                          '19344','31100','14371','47157','70357',
                          '81715','42708','28845','96699','29479',
                          '78676','50907','26621','65545','64296',
                          '36498','11386','41035','37947','78291',
                          '82294','59198','25007','18680','23836',
                          '52776','98361','62030','26548','66096',
                          '15140','31380','49667','39914','99907',
                          '16857','62044','28777','93103','22948',
                          '40161','71942','10310','98447','88078',
                          '44055','95729','36187','68260','74272',
                          '90765','15915','25236','58291','61415',
                          '30779','44758','97585','53982','75935',
                          '57017','22885','42172','62490','40490',
                          '92295','63916','42694','17390','64268',
                          '28981','27902','21847','56904','49052',
                          '17126','56821','94231','49070','32440',
                          '57887','11181','93658','12680','19027',
                          '85456','11766','41052','89239','85444',
                          '89958','29684','96147','36784','20763',
                          '36075','55806','11311','34643','99846',
                          '77309','57759','43925','29842','45898',
                          '92435','24590','47594','66679','37547',
                          '27104','22383','46707','15873','35468',
                          '84671','79278','11415','44776','35562',
                          '22428','32065','42884','76029','29889',
                          '85500','84166','70983','92239','94371',
                          '83364','97939','45304','13680','14815',
                          '87181','69068','76527','63391','14503',
                          '57782','48931','65516','56554','85580',
                          '90893','60804','73481','99879','68889',
                          '91973','20870','28187','38899','67801',
                          '33154','97449','30611','35311','23817',
                          '25504','49676','26416','93102','32039',
                          '88476','30700','96307','49298','16571',
                          '71649','99513','14618','15923','33480',
                          '16134','13077','11702','17549','44911',
                          '14615','20814','56957','58210','32581',
                          '11811','61363','57280','29426','72062',
                          '16363','25526','27317','70631','83257',
                          '78846','84367','38731','94258')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100

